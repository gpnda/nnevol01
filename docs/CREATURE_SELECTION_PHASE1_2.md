# Фаза 1 и 2: Выбор существа при клике ✅

## Что реализовано

### Фаза 1: Viewport — определение существа при клике

**Файл:** `renderer/v2/gui_viewport.py`

**Новый метод:**
```python
def get_creature_at_position(self, screen_pos: tuple) -> Creature | None:
    """
    Получить существо в точке клика.
    
    Преобразует экранные координаты клика в координаты карты,
    затем ищет существо в этой клетке.
    """
```

**Алгоритм:**
1. Преобразуем экранные координаты в координаты карты: `screen_to_map()`
2. Ограничиваем координаты целыми числами (координаты клеток)
3. Проходимся по `self.world.creatures` и ищем существо с подходящими координатами
4. Возвращаем существо или `None`

---

### Фаза 2: Renderer — управление выбранным существом

**Файл:** `renderer/v2/renderer.py`

#### 2.1 Переменная состояния

```python
def __init__(self, world, app):
    # ...
    self.selected_creature = None  # Текущее выбранное существо
```

#### 2.2 Обработка события клика (правая кнопка мыши)

```python
def _handle_mouse(self, event):
    if self.current_state == 'main':
        # Правая кнопка мыши - выбор существа
        if event.type == pygame.MOUSEBUTTONDOWN and event.button == 3:
            creature = self.viewport.get_creature_at_position(event.pos)
            if creature:
                self.selected_creature = creature
                print(f"✓ Creature selected: UID={creature.uid}, pos=({creature.x}, {creature.y})")
            else:
                self.selected_creature = None
                print("✗ No creature at this position")
        
        # Остальные события мыши (пан, зум)
        self.viewport.handle_event(event)
```

#### 2.3 Очистка выбора при открытии модального окна

```python
def set_state(self, state_name):
    if state_name != 'main':
        self.app.is_running = False
        self.selected_creature = None  # Очищаем выбор при открытии popup
```

---

## Управление

### Горячие клавиши мыши

| Действие | Клавиша | Результат |
|----------|---------|-----------|
| Выбрать существо | **ПКМ (правая)** | Выбор существа, print в консоль |
| Панорамирование карты | **ЛКМ + Drag** | Движение карты |
| Масштабирование | **Колесико ↑/↓** | Приближение/отдаление |

---

## Output в консоли

При выборе существа вы увидите:
```
✓ Creature selected: UID=12, pos=(45, 32)
```

При клике на пустое место:
```
✗ No creature at this position
```

---

## Поток данных

```
┌─────────────────────────────────────────────────┐
│ Пользователь кликает ПКМ на существо            │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Renderer._handle_mouse()                        │
│ - Проверяет event.button == 3 (ПКМ)             │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Viewport.get_creature_at_position(event.pos)    │
│ - Преобразует координаты                        │
│ - Ищет существо в мире                          │
└────────────────┬────────────────────────────────┘
                 ↓
┌─────────────────────────────────────────────────┐
│ Renderer.selected_creature = creature           │
│ print(UID, position)                            │
└─────────────────────────────────────────────────┘
```

---

## Структура данных selected_creature

```python
self.selected_creature  # Объект Creature с атрибутами:
├── uid              # Уникальный ID
├── x, y             # Координаты на карте
├── age              # Возраст в тиках
├── energy           # Текущая энергия
├── speed            # Скорость
├── angle            # Направление взгляда
├── nn               # Нейронная сеть
├── birth_ages       # Возрасты размножения
└── ... другие атрибуты Creature
```

---

## Следующие шаги (Фаза 3)

Когда будете готовы, создадим `SelectedCreaturePanel` для отображения:
- UID и координаты
- Возраст и поколение
- Текущую энергию
- Информацию о нейронной сети
- И другую полезную информацию

---

## Тестирование

```bash
python nnevol.py
# Кликните ПКМ на любое существо на карте
# В консоли должна появиться информация о выбранном существе
```

Успехов! 🚀
